
### mutex 正常模式 加锁
* 尝试CAS直接加锁
* 若无法直接获取，进行多次自旋尝试
* 多次尝试失败，会进入 Sema 队列休眠


             Mutex    SeamRoot
           ---------   ------- 
          |  state  | | treap |
           ---------   -------
          |   sema  |  nwait  |
          --------------------

G1 和 G2 同时去竞争Locked，假如G1抢到，则将 Locked 设为 1,这时候 G2 会多次自旋
G2 自旋多次失败，会休眠自己(去获取seam，seam=0视为等待队列)，同时记录在一个seamRoot结构体里头 平衡二叉树(sudog)

                             G1  G2                                       G1  G2(自旋)                                                    
                    state      \/                                state      \/                                                      
          -------------------------                    -------------------------        结构体发生的变化                                          
          |  0  |  0  |  0  |  0  |      ----->        |  1  |  0  |  0  |  1  |         ---------                                        
          -------------------------                    -------------------------                  |                                                               
            /      \       \       \                     /      \       \       \                 |                                                                 
     WaiterShift  Staving  Woken  Locked          WaiterShift  Staving  Woken  Locked             |
                                                                                                 \|/
                                                                                             
             Mutex    SeamRoot                G2                 G3
          ----------   -------            -------             -------  
          |  state  | | treap |  ------> | sudog |    -----> | sudog | 
          ----------   -------            -------             -------   
          |   sema  | | nwait |                       
          ----------  --------                      
                                      
                              G1  G3(自旋)                                   
                     state      \/                                         
           -------------------------                                       
           |  2  |  0  |  0  |  1  |                                       
           -------------------------                                       
             /      \       \       \                                      
      WaiterShift  Staving  Woken  Locked

### 正常模式 解锁
* 检查是否其他协程在等待，如果有的话，会去唤醒 sema ，从 sema 获取等待的协程，重新调度。
* 当等待的 G2可以抢锁，但有可能很多协程与它共同抢，最坏的情况可能还抢不到，继续放到 sema 队列里头等待（正常模式出现的弊端）


                               G1(释放锁)                  可能  --->       G2 G3 Gn                                                  
                    state      |                                state      \ | /                                                    
          -------------------------                    -------------------------                                         
          |  2  |  0  |  0  |  1  |      ----->        |  1  |  0  |  0  |  0  |                                          
          -------------------------                    -------------------------                                                                 
            /      \       \       \                     /      \       \       \                                                                  
     WaiterShift  Staving  Woken  Locked          WaiterShift  Staving  Woken  Locked   
                                                                                        

> 总结： 
> * Mutex 正常模式使用的是：自旋锁 + sema休眠等待，来解决并发安全的。
> * 存在弊端：正常模式下，协程有可能进入饥饿模式，造成不公平。


### Mutex 饥饿模式

什么时候会进入饥饿模式？
* 锁竞争严重，会进入饥饿模式
* 当前协程等待锁的时间超过了 1 ms ，就会进入饥饿模式；如果没有协程在等待队列中，自然回归到正常模式。
* 在饥饿模式中，当新协程发现锁被占用后，直接进入 Seam 休眠状态。(正常模式是需要自旋，饥饿模式不需要自旋)
* 进入饥饿模式中，在休眠的协程会优先获取锁。(类似老板优先提拔老员工，而不是与每个进来新人竞争,新来的直接乖乖休眠等待)



                             G1(释放-去唤醒等待G2)                             G2                                                
                    state      |                                state        |                                                     
          -------------------------                    -------------------------                                         
          |  1  |  1  |  0  |  0  |      ----->        |  1  |  0  |  0  |  1  |      (staving=0,没有等待队列，退出饥饿模式)                                    
          -------------------------                    -------------------------                                                                 
            /      \       \       \                     /      \       \       \                                                                  
     WaiterShift  Staving  Woken  Locked          WaiterShift  Staving  Woken  Locked   


             Mutex    SeamRoot               G2    
          ----------   -------            -------   
          |  state  | | treap |  ------> | sudog |  
          ----------   -------            -------   
          | sema=0  | | nwait |                       
          ----------  --------                      
                                                                                                                       
                                                                                                    
                                                                                                    

                                                                                             
                                                                                             
                                                                                             
                                                                                             
                                                                                             
                                                                                             
                                                                                             
                                                                                             
                                                                                             
                                                                                             
                                                                                             

